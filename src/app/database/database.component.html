<form [formGroup]="form" (ngSubmit)="searchCards()" id="top">
    <div class="form-group row">
        <label class="col-3 col-md-1 col-form-label">Regions</label>
        <div class="col-9 col-md-11 image-checkboxes-container">
            <div class="form-check form-check-inline" formArrayName="regions"
                *ngFor="let region of regionFormArray.controls; let i = index">
                <input class="form-check-input" type="checkbox" [id]="'region' + regionsData[i].id"
                    [formControlName]="i">
                <label class="form-check-label" [for]="'region' + regionsData[i].id">
                    <img *ngIf="regionsData[i].icon" [src]="'./assets/icons/' + regionsData[i].icon + '.png'">
                    <!-- <span *ngIf="regionsData[i].name">{{regionsData[i].name }}</span> -->
                </label>
            </div>
        </div>
    </div>
    <div class="form-group row">
        <label class="col-3 col-md-1 col-form-label">Sets</label>
        <div class="col-9 col-md-11 image-checkboxes-container">
            <div class="form-check form-check-inline" formArrayName="sets"
                *ngFor="let region of setFormArray.controls; let i = index">
                <input class="form-check-input" type="checkbox" [id]="'set' + setsData[i].id" [formControlName]="i">
                <label class="form-check-label" [for]="'set' + setsData[i].id"
                    [ngClass]="{'form-check-label-no-icon': !setsData[i].icon}">
                    <img *ngIf="setsData[i].icon" [src]="'./assets/icons/' + setsData[i].icon + '.png'">
                    <span *ngIf="setsData[i].name">{{setsData[i].name }}</span>
                </label>
            </div>
        </div>
    </div>
    <div class="form-group row">
        <label class="col-3 col-md-1 col-form-label">Card Types</label>
        <div class="col-9 col-md-11 image-checkboxes-container">
            <ng-container *ngFor="let cardType of cardTypesData; let i = index">
                <div class="form-check form-check-inline" formArrayName="cardTypes">
                    <input class="form-check-input" type="checkbox" [id]="'cardType' + cardType.id"
                        [formControlName]="cardType.index">
                    <label class="form-check-label" [for]="'cardType' + cardType.id"
                        [ngClass]="{'form-check-label-no-icon': !cardType.icon}">
                        <img *ngIf="cardType.icon" [src]="'./assets/icons/' + cardType.icon + '.png'">
                        <span *ngIf="cardType.name">{{cardType.name }}</span>
                    </label>
                </div>
                <ng-container *ngFor="let cardTypeChild of cardType.children; let j = index">
                    <div class="form-check form-check-inline secondary-controls" formArrayName="cardTypes"
                        [ngClass]="{'active': cardTypeFormArray.controls[cardType.index].value }">
                        <input class="form-check-input" type="checkbox" [id]="'cardType' + cardTypeChild.id"
                            [formControlName]="cardTypeChild.index">
                        <label class="form-check-label" [for]="'cardType' + cardTypeChild.id">
                            <img *ngIf="cardTypeChild.icon" [src]="'./assets/icons/' + cardTypeChild.icon + '.png'">
                            <span *ngIf="cardTypeChild.name">{{cardType.name }}</span>
                        </label>
                    </div>
                </ng-container>
            </ng-container>
        </div>
    </div>
    <div class="form-group row">
        <label class="col-3 col-md-1 col-form-label">Collectible</label>
        <div class="col-9 col-md-5 image-checkboxes-container">
            <div class="form-check form-check-inline" formArrayName="collectibles"
                *ngFor="let region of collectibleFormArray.controls; let i = index">
                <input class="form-check-input" type="checkbox" [id]="'collectible' + collectibleData[i].id"
                    [formControlName]="i">
                <label class="form-check-label" [for]="'collectible' + collectibleData[i].id">
                    <img *ngIf="collectibleData[i].icon" [src]="'./assets/icons/' + collectibleData[i].icon + '.png'">
                    <span *ngIf="collectibleData[i].name">{{collectibleData[i].name }}</span>
                </label>
            </div>
        </div>
        <label class="col-3 col-md-1 col-form-label">Groups</label>
        <div class="col-9 col-md-5">
            <ng-select #groupSelector [(ngModel)]="selectedGroups" [ngModelOptions]="{standalone: true}"
                [multiple]="true" [markFirst]="true" [placeholder]="'Groups like Tech, Dragon'">
                <ng-option *ngFor="let group of groups" [value]="group.name">
                    {{group.name}}
                </ng-option>
            </ng-select>
        </div>
    </div>
    <div class="form-group row">
        <label class="col-3 col-md-1 col-form-label">Card Search</label>
        <div class="col-9 col-md-11">
            <div class="input-group mb-3">
                <button *ngIf="form.get('text').value.length != 0" class="btn btn-secondary" type="button"
                    (click)="clearTextSearch()">Clear</button>
                <input type="text" class="form-control" formControlName="text" [autofocus]="true"
                    placeholder="Card Name, Card Text, Keywords or even Card Code">
            </div>
        </div>
    </div>
    <div class="form-group row keyword-container">
        <label class="col-3 col-md-1 col-form-label">Keywords</label>
        <div class="col-9 col-md-11">
            <ng-select #keywordSelector [(ngModel)]="selectedKeywords" [ngModelOptions]="{standalone: true}"
                [multiple]="true" [markFirst]="true" [placeholder]="'Keywords like Barrier, Play'">
                <ng-option *ngFor="let keyword of keywords" [value]="keyword.name">
                    <img *ngIf="keyword.icon" [src]="'./assets/icons/keywords/' + keyword.icon + '.png'" width="20px">
                    {{keyword.name}}
                </ng-option>
            </ng-select>
        </div>
    </div>
    <div class="form-group row" *ngIf="isMobile">
        <label class="col-3 col-form-label">Artist</label>
        <div class="col-9">
            <ng-select #artistSelector [(ngModel)]="selectedArtists" [ngModelOptions]="{standalone: true}"
                [multiple]="true" [maxSelectedItems]="1" [markFirst]="true"
                [placeholder]="'Artist like SIXMOREVODKA, Dao Le'">
                <ng-option *ngFor="let artist of artist" [value]="artist.name">
                    {{artist.name}}
                </ng-option>
            </ng-select>
        </div>
    </div>

    <div class="collapse" id="advanceCollapse">
        <div class="form-group row">
            <label class="col-3 col-md-1 col-form-label">Cost</label>
            <div class="col-9 col-md-11 image-checkboxes-container">
                <div class="form-check form-check-inline" formArrayName="costs"
                    *ngFor="let region of costFormArray.controls; let i = index">
                    <input class="form-check-input" type="checkbox" [id]="'cost' + costData[i].id"
                        [formControlName]="i">
                    <label class="form-check-label" [for]="'cost' + costData[i].id"
                        [ngClass]="{'circle': !!costData[i].circle}">
                        <img *ngIf="costData[i].icon" [src]="'./assets/icons/' + costData[i].icon + '.png'">
                        <span *ngIf="costData[i].name">{{costData[i].name }}</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="form-group row mb-2">
            <label class="col-3 col-md-1 col-form-label">Rarity</label>
            <div class="col-9 col-md-11 image-checkboxes-container">
                <div class="form-check form-check-inline" formArrayName="rarities"
                    *ngFor="let region of rarityFormArray.controls; let i = index">
                    <input class="form-check-input" type="checkbox" [id]="'rarity' + rarityData[i].id"
                        [formControlName]="i">
                    <label class="form-check-label" [for]="'rarity' + rarityData[i].id"
                        [ngClass]="{'circle': !!rarityData[i].circle}">
                        <img *ngIf="rarityData[i].icon"
                            [src]="'./assets/currency/Wildcard_' + rarityData[i].icon + '.png'">
                        <span *ngIf="rarityData[i].name">{{rarityData[i].name }}</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="form-group row mb-2">
            <label class="col-3 col-md-1 col-form-label">Artist</label>
            <div class="col-9 col-md-11">
                <ng-select #artistSelector [(ngModel)]="selectedArtists" [ngModelOptions]="{standalone: true}"
                    [multiple]="true" [maxSelectedItems]="1" [markFirst]="true"
                    [placeholder]="'Artist like SIXMOREVODKA, Dao Le'">
                    <ng-option *ngFor="let artist of artist" [value]="artist.name">
                        {{artist.name}}
                    </ng-option>
                </ng-select>
            </div>
        </div>
    </div>

    <div class="form-group row text-center">
        <div class="col-12">
            <button type="button" class="btn btn-info" (click)="clearFilters()">Clear Filters</button>
            <button class="btn btn-primary ms-2" type="button" data-bs-toggle="collapse"
                data-bs-target="#advanceCollapse" aria-expanded="false" aria-controls="advanceCollapse">
                More Filters
            </button>
            <button type="submit" class="btn btn-primary ms-2">Search</button>
        </div>
    </div>
</form>

<div class="text-center mt-3" *ngIf="!isCompleted">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="search-result" *ngIf="isCompleted">
    <div class="mt-3">Found {{searchResults.length}} card(s).</div>

    <div class="btn-group mt-3" role="group" aria-label="Select sort type" *ngIf="isCompleted">
        <ng-container *ngFor="let sort of sortData">
            <input type="radio" class="btn-check" name="btnradio" [id]="'btnradio_' + sort.id" autocomplete="off"
                (change)="changeSort(sort.id)" [checked]="sort.id == sortType">
            <label class="btn btn-outline-primary" [for]="'btnradio_' + sort.id">{{sort.name}}</label>
        </ng-container>
    </div>

    <div class="row row-cols-auto g-4 mt-2">
        <ng-container *ngFor="let card of searchResults; let resultIndex = index"
            [ngTemplateOutlet]='!card.detail ? cardInfo : cardDetail'
            [ngTemplateOutletContext]="{card: card, resultIndex: resultIndex}">
        </ng-container>
        <ng-template #cardInfo let-card="card" let-resultIndex="resultIndex">
            <div class="card-info col-6 col-md-2" [id]="'card_' + card.code">
                <div class="card h-100">
                    <div class="card-header text-center">
                        <small class="text-muted ">{{card.code}}<span class="to-clipboard"
                                (click)="card2Clipboard(card)">📋</span></small>
                    </div>
                    <img class="card-img-top" [defaultImage]="defaultImage" [lazyLoad]="getAPIImage(card.code)"
                        [alt]="card.code" (click)="selectCardInfo(resultIndex)">
                    <div class="card-body">
                        <h5 class="card-title text-center">
                            {{card.name}}
                            <a [href]="'https://leagueoflegends.fandom.com/wiki/' + card.code + ' (Legends_of_Runeterra)'"
                                target="_blank">
                                <svg width="24px" height="24px" viewBox="0 0 24 24">
                                    <g stroke="#0d6efd" stroke-width="1.5" fill="none" fill-rule="evenodd"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="17 13.5 17 19.5 5 19.5 5 7.5 11 7.5"></polyline>
                                        <path d="M14,4.5 L20,4.5 L20,10.5 M20,4.5 L11,13.5"></path>
                                    </g>
                                </svg>
                            </a>
                        </h5>
                    </div>
                </div>
            </div>
        </ng-template>
        <ng-template #cardDetail let-card="card" let-resultIndex="resultIndex">
            <div class="card-detail col-12" [id]="'detail_' + card.code">
                <div class="card h-100">
                    <div class="card-header text-center">
                        <small class="text-muted ">{{card.code}}</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 col-md-11">
                                <div class="row">
                                    <div class="col-md-3 d-none d-md-block">
                                        <img class="card-image" [defaultImage]="defaultImage"
                                            [lazyLoad]="getAPIImage(card.code)" [alt]="card.code" width="250px">
                                    </div>
                                    <div class="col-12 col-md-9">
                                        <div class="row">
                                            <h5 class="card-title text-center">
                                                {{card.name}}
                                                <a [href]="'https://leagueoflegends.fandom.com/wiki/' + card.code + ' (Legends_of_Runeterra)'"
                                                    target="_blank">
                                                    <svg width="24px" height="24px" viewBox="0 0 24 24">
                                                        <g stroke="#0d6efd" stroke-width="1.5" fill="none"
                                                            fill-rule="evenodd" stroke-linecap="round"
                                                            stroke-linejoin="round">
                                                            <polyline points="17 13.5 17 19.5 5 19.5 5 7.5 11 7.5">
                                                            </polyline>
                                                            <path d="M14,4.5 L20,4.5 L20,10.5 M20,4.5 L11,13.5"></path>
                                                        </g>
                                                    </svg>
                                                </a>
                                            </h5>
                                        </div>
                                        <div class="row">
                                            <form class="border-0">
                                                <div class="form-group row">
                                                    <label class="col-4 col-md-2 col-form-label">Type</label>
                                                    <div class="col-8 col-md-4">
                                                        <input class="form-control-plaintext" type="text" readonly
                                                            value="{{card.type}}">
                                                    </div>
                                                    <label class="col-4 col-md-2 col-form-label">Region</label>
                                                    <div class="col-8 col-md-4 position-relative">
                                                        <img class="position-absolute top-50 region"
                                                            [src]="'./assets/icons/' + getRegion(card.code) + '.png'"
                                                            width="50xp">
                                                    </div>
                                                    <label class="col-4 col-md-2 col-form-label">Cost</label>
                                                    <div class="col-8 col-md-4">
                                                        <input class="form-control-plaintext" type="text" readonly
                                                            value="{{card.cost}}">
                                                    </div>
                                                </div>
                                                <div class="form-group row" *ngIf="card.description">
                                                    <label class="col-4 col-md-2 col-form-label">Description</label>
                                                    <div class="col-8 col-md-10">
                                                        <textarea autosize class="form-control-plaintext"
                                                            readonly>{{card.description}}</textarea>
                                                    </div>
                                                </div>
                                                <div class="form-group row" *ngIf="card.levelupDescription">
                                                    <label class="col-4 col-md-2 col-form-label">Level Up</label>
                                                    <div class="col-8 col-md-10">
                                                        <textarea autosize class="form-control-plaintext"
                                                            readonly>{{card.levelupDescription}}</textarea>
                                                    </div>
                                                </div>
                                                <fieldset class="form-group row"
                                                    *ngIf="['Follower','Champion'].includes(card.type)">
                                                    <label class="col-4 col-md-2 col-form-label">Power</label>
                                                    <div class="col-8 col-md-4"><input class="form-control-plaintext"
                                                            type="text" readonly value="{{card.power}}"></div>
                                                    <label class="col-4 col-md-2 col-form-label">Health</label>
                                                    <div class="col-8 col-md-4"><input class="form-control-plaintext"
                                                            type="text" readonly value="{{card.health}}"></div>
                                                </fieldset>
                                                <div class="form-group row">
                                                    <label class="col-4 col-md-2 col-form-label">Flavor</label>
                                                    <div class="col-8 col-md-10">
                                                        <textarea autosize class="form-control-plaintext"
                                                            readonly>{{card.flavor}}</textarea>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <div>Artwork ({{card.artist || 'Unknown'}}):</div>
                                        <img class="rounded mx-auto d-block" [defaultImage]="defaultArtwork"
                                            [lazyLoad]="getAPIArtwork(card.code)" [alt]="card.code"
                                            [attr.width]="isMobile ? '100%' : 'auto'"
                                            [attr.height]="isMobile ? 'auto' : '500px'">
                                    </div>
                                </div>
                            </div>

                            <div
                                [ngClass]="{'col-md-1 mt-md-0 d-grid gap-5': !isMobile, 'col-12 mt-3 d-flex justify-content-around gap-3': isMobile }">
                                <button *ngIf="!isMobile" class="invisible"></button>
                                <button class="btn btn-primary gap-2 w-100" type="button"
                                    (click)="selectCardDetail(resultIndex)">Close</button>
                                <button class="btn btn-secondary w-100" type="button"
                                    (click)="hideAllCardDetails(resultIndex)">Close All</button>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </ng-template>
    </div>

    <div class="back-to-top-wrapper">
        <a href="database#top" class="back-to-top-link" aria-label="Scroll to Top">
            <i class="bi bi-chevron-double-up"></i>
        </a>
    </div>
</div>